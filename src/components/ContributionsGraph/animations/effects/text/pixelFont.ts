/** 字符位图类型 - 每行用数字表示，位表示像素点 */
export type CharBitmap = number[]

/** 像素字体定义 */
export interface PixelFont {
  /** 字符宽度 */
  charWidth: number
  /** 字符高度 */
  charHeight: number
  /** 字符间距 */
  spacing: number
  /** 空格宽度 */
  spaceWidth: number
  /** 字符位图数据 */
  chars: Record<string, CharBitmap>
}

/**
 * 3x5 像素字体
 * 每个字符用 5 行数字表示，每行的二进制位表示像素点
 * 例如: 0b101 表示第 1、3 位有像素点
 */
export const PIXEL_FONT_3X5: PixelFont = {
  charWidth: 3,
  charHeight: 5,
  spacing: 1,
  spaceWidth: 2,
  chars: {
    // 大写字母 A-Z
    A: [0b010, 0b101, 0b111, 0b101, 0b101],
    B: [0b110, 0b101, 0b110, 0b101, 0b110],
    C: [0b011, 0b100, 0b100, 0b100, 0b011],
    D: [0b110, 0b101, 0b101, 0b101, 0b110],
    E: [0b111, 0b100, 0b110, 0b100, 0b111],
    F: [0b111, 0b100, 0b110, 0b100, 0b100],
    G: [0b011, 0b100, 0b101, 0b101, 0b011],
    H: [0b101, 0b101, 0b111, 0b101, 0b101],
    I: [0b111, 0b010, 0b010, 0b010, 0b111],
    J: [0b001, 0b001, 0b001, 0b101, 0b010],
    K: [0b101, 0b101, 0b110, 0b101, 0b101],
    L: [0b100, 0b100, 0b100, 0b100, 0b111],
    M: [0b101, 0b111, 0b101, 0b101, 0b101],
    N: [0b101, 0b111, 0b111, 0b101, 0b101],
    O: [0b010, 0b101, 0b101, 0b101, 0b010],
    P: [0b110, 0b101, 0b110, 0b100, 0b100],
    Q: [0b010, 0b101, 0b101, 0b110, 0b011],
    R: [0b110, 0b101, 0b110, 0b101, 0b101],
    S: [0b011, 0b100, 0b010, 0b001, 0b110],
    T: [0b111, 0b010, 0b010, 0b010, 0b010],
    U: [0b101, 0b101, 0b101, 0b101, 0b010],
    V: [0b101, 0b101, 0b101, 0b101, 0b010],
    W: [0b101, 0b101, 0b101, 0b111, 0b101],
    X: [0b101, 0b101, 0b010, 0b101, 0b101],
    Y: [0b101, 0b101, 0b010, 0b010, 0b010],
    Z: [0b111, 0b001, 0b010, 0b100, 0b111],

    // 小写字母 a-z (使用与大写相同的样式，但可以根据需要调整)
    a: [0b010, 0b101, 0b111, 0b101, 0b101],
    b: [0b110, 0b101, 0b110, 0b101, 0b110],
    c: [0b011, 0b100, 0b100, 0b100, 0b011],
    d: [0b110, 0b101, 0b101, 0b101, 0b110],
    e: [0b111, 0b100, 0b110, 0b100, 0b111],
    f: [0b111, 0b100, 0b110, 0b100, 0b100],
    g: [0b011, 0b100, 0b101, 0b101, 0b011],
    h: [0b101, 0b101, 0b111, 0b101, 0b101],
    i: [0b111, 0b010, 0b010, 0b010, 0b111],
    j: [0b001, 0b001, 0b001, 0b101, 0b010],
    k: [0b101, 0b101, 0b110, 0b101, 0b101],
    l: [0b100, 0b100, 0b100, 0b100, 0b111],
    m: [0b101, 0b111, 0b101, 0b101, 0b101],
    n: [0b101, 0b111, 0b111, 0b101, 0b101],
    o: [0b010, 0b101, 0b101, 0b101, 0b010],
    p: [0b110, 0b101, 0b110, 0b100, 0b100],
    q: [0b010, 0b101, 0b101, 0b110, 0b011],
    r: [0b110, 0b101, 0b110, 0b101, 0b101],
    s: [0b011, 0b100, 0b010, 0b001, 0b110],
    t: [0b111, 0b010, 0b010, 0b010, 0b010],
    u: [0b101, 0b101, 0b101, 0b101, 0b010],
    v: [0b101, 0b101, 0b101, 0b101, 0b010],
    w: [0b101, 0b101, 0b101, 0b111, 0b101],
    x: [0b101, 0b101, 0b010, 0b101, 0b101],
    y: [0b101, 0b101, 0b010, 0b010, 0b010],
    z: [0b111, 0b001, 0b010, 0b100, 0b111],

    // 数字 0-9
    0: [0b010, 0b101, 0b101, 0b101, 0b010],
    1: [0b010, 0b110, 0b010, 0b010, 0b111],
    2: [0b110, 0b001, 0b010, 0b100, 0b111],
    3: [0b110, 0b001, 0b010, 0b001, 0b110],
    4: [0b101, 0b101, 0b111, 0b001, 0b001],
    5: [0b111, 0b100, 0b110, 0b001, 0b110],
    6: [0b011, 0b100, 0b110, 0b101, 0b010],
    7: [0b111, 0b001, 0b010, 0b010, 0b010],
    8: [0b010, 0b101, 0b010, 0b101, 0b010],
    9: [0b010, 0b101, 0b011, 0b001, 0b110],

    // 常用符号
    ' ': [0b000, 0b000, 0b000, 0b000, 0b000],
    '.': [0b000, 0b000, 0b000, 0b000, 0b010],
    ',': [0b000, 0b000, 0b000, 0b010, 0b100],
    '!': [0b010, 0b010, 0b010, 0b000, 0b010],
    '?': [0b110, 0b001, 0b010, 0b000, 0b010],
    '-': [0b000, 0b000, 0b111, 0b000, 0b000],
    '+': [0b000, 0b010, 0b111, 0b010, 0b000],
    ':': [0b000, 0b010, 0b000, 0b010, 0b000],
    '/': [0b001, 0b001, 0b010, 0b100, 0b100],
    '(': [0b001, 0b010, 0b010, 0b010, 0b001],
    ')': [0b100, 0b010, 0b010, 0b010, 0b100],
    '[': [0b011, 0b010, 0b010, 0b010, 0b011],
    ']': [0b110, 0b010, 0b010, 0b010, 0b110],
    '\'': [0b010, 0b010, 0b000, 0b000, 0b000],
    '"': [0b101, 0b101, 0b000, 0b000, 0b000],
    _: [0b000, 0b000, 0b000, 0b000, 0b111],
    '=': [0b000, 0b111, 0b000, 0b111, 0b000],
    '*': [0b000, 0b101, 0b010, 0b101, 0b000],
    '#': [0b101, 0b111, 0b101, 0b111, 0b101],
    '@': [0b010, 0b101, 0b111, 0b100, 0b011],
    '&': [0b010, 0b101, 0b010, 0b101, 0b011],
    '%': [0b101, 0b001, 0b010, 0b100, 0b101],
    '^': [0b010, 0b101, 0b000, 0b000, 0b000],
    '<': [0b001, 0b010, 0b100, 0b010, 0b001],
    '>': [0b100, 0b010, 0b001, 0b010, 0b100],

    // 箭头符号 (特殊处理，宽度可能不同)
    '→': [0b000, 0b010, 0b111, 0b010, 0b000],
    '←': [0b000, 0b010, 0b111, 0b010, 0b000],
    '↑': [0b010, 0b111, 0b010, 0b010, 0b010],
    '↓': [0b010, 0b010, 0b010, 0b111, 0b010],
  },
}

/** 默认字体 */
export const DEFAULT_PIXEL_FONT = PIXEL_FONT_3X5

/**
 * 获取字符的位图数据
 * @param char 字符
 * @param font 字体
 * @returns 字符位图，如果字符不存在则返回 undefined
 */
export function getCharBitmap(
  char: string, font: PixelFont = DEFAULT_PIXEL_FONT,
): CharBitmap | undefined {
  return font.chars[char]
}

/**
 * 检查字符在指定位置是否有像素点
 * @param bitmap 字符位图
 * @param x 横坐标 (0 为最左边)
 * @param y 纵坐标 (0 为最上边)
 * @param charWidth 字符宽度
 * @returns 是否有像素点
 */
export function hasPixelAt(bitmap: CharBitmap, x: number, y: number, charWidth: number): boolean {
  if (y < 0 || y >= bitmap.length || x < 0 || x >= charWidth) {
    return false
  }

  const row = bitmap[y]
  // 从左到右，最高位是最左边的像素
  const bitPosition = charWidth - 1 - x

  return ((row >> bitPosition) & 1) === 1
}
